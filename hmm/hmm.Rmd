---
title: "Hidden Markov Models"
author: "[Michael Love](http://mikelove.github.io)"
output: html_document
---

> We selected a subset of the data set presented in Snijders et
> al. (2001). We are calling this data set coriell. The data correspond
> to two array CGH studies of fibroblast cell strains. In particular, we
> chose the studies GM05296 and GM13330. After selecting only the mapped
> data from chromosomes 1-22 and X, there are 2271 data points. 

```{r}
library(DNAcopy)
data(coriell)
plot(coriell$Coriell.05296)
cna <- CNA(cbind(coriell$Coriell.05296),
           coriell$Chromosome,coriell$Position,
           data.type="logratio", sampleid="c05296")
smo <- smooth.CNA(cna)
Y <- smo$c05296
Y <- Y[!is.na(Y)]
plot(Y)
plot(Y, xlim=c(1100,1400))
abline(h=.25)
plot(Y)
abline(h=.25)
```

```{r}
T <- length(Y)
# initial guess
n <- 3
pi <- rep(1/n, n)
xseq <- seq_len(n)
A <- matrix(.01, nrow=n, ncol=n)
diag(A) <- .99
A[1,n] <- A[n,1] <- 0 # only makes sense for CNV here
mus <- c(-.5,0,.5)
B <- function(j, Y) {
  dnorm(Y,mus[j],.1)
}

# alpha_i,t = P(Y_1=y_1,...,Y_t=y_t,X_t=i|theta)
alpha <- matrix(0,nrow=nstates,ncol=T)
alpha[,1] <- pi * B(1:nstates,Y[1])
for (t in 2:T) {
  for (j in xseq) {
    alpha[j,t] <- B(j,Y[t]) * sum(alpha[,t-1] * A[,j])
  }
  alpha[,t] <- alpha[,t] / sum(alpha[,t])
}

# beta_i,t = P(Y_t+1=y_t+1,...,Y_T=y_T|X_t=i,theta)
beta <- matrix(0,nrow=length(pi),ncol=T)
beta[,T] <- 1
for (t in (T-1):1) {
  for (i in xseq) {
    beta[i,t] <- sum(beta[,t+1] * A[i,] * B(1:nstates,Y[t+1]))
  }
  beta[,t] <- beta[,t] / sum(beta[,t])
}

# gamma_i,t = P(X_t=i|Y,theta)
gamma <- alpha * beta
gamma <- t( t(gamma) / colSums(gamma) )

par(mfrow=c(2,1),mar=c(3,3,4,1))
plot(Y, xlab="", ylab="", main="data: X_t")
plot(seq_len(T), gamma[2,], type="l", xlab="", ylab="",
     main="P(X_t = state 1 | Y,theta)")
```

```{r}
# V_i,t is the probability of the most probable sequence up to t,
# having i as final state
V <- matrix(0,nrow=n,ncol=T)
V[,1] <- pi * B(1:n,Y[1])
Ptr <- matrix(0,nrow=length(pi),ncol=T)
for (t in 2:T) {
  for (i in xseq) {
    V[i,t] <- B(i,Y[t]) * max(V[,t-1] * A[,i])
    Ptr[i,t] <- which.max(V[,t-1] * A[,i])
  }
  V[,t] <- V[,t] / sum(V[,t])
}
x.hat <- numeric(T)
x.hat[T] <- which.max(V[,T])
for (t in (T-1):1) {
  x.hat[t] <- Ptr[x.hat[t+1],t+1]
}
par(mfrow=c(2,1),mar=c(3,3,4,1))
plot(Y, xlab="", ylab="", main="data: X_t")
plot(seq_len(T), x.hat, type="l", xlab="", ylab="",
     main="The Viterbi sequence")
```

```{r}
### fix this for continuous Y...

# xi_i,j,t = P(X_t = i,X_t+1 = j|Y,theta)
xi <- array(0, dim=c(nrow(B),ncol(B),T-1))
for (t in seq_len(T-1)) {
  for (i in xseq) {
    for (j in seq_len(ncol(B))) {
      xi[i,j,t] <- alpha[i,t]*A[i,j]*beta[j,t+1]*B(j,Y[t+1])
    }
  }
  xi[,,t] <- xi[,,t] / sum(xi[,,t])
}

pi.hat <- gamma[,1]
A.hat <- apply(xi, c(1,2), sum) / rowSums(gamma[,-T])
B.hat  <- matrix(c(sum(gamma[1,Y==1]), sum(gamma[1,Y==2]),
                   sum(gamma[2,Y==1]), sum(gamma[2,Y==2])),
                 byrow=TRUE, ncol=2) / rowSums(gamma)

###
```
