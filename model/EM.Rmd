---
title: "Expectation maximization"
author: "[Michael Love](http://mikelove.github.io)"
output: html_document
---

$$ \textrm{max}_\theta \textrm{E}_{Z|X,\theta^t} \left[ \log L(\theta; X, Z) \right] $$

$$ = \textrm{E}_{Z|X,\theta^t} \left[ \log \prod_i \prod_c \pi_c f(x_i; \mu_c)^{\mathbb{1}(z_i = c)} \right] $$

$$ = \textrm{E}_{Z|X,\theta^t} \left[ \sum_i \sum_c \mathbb{1}(z_i = c) (\log \pi_c + \log f(x_i; \mu_c)) \right] $$

$$ \sum_i \sum_c \textrm{E}_{Z|X,\theta^t} \mathbb{1}(z_i = c) \left( \log \pi_c + \log \frac{1}{2\pi} - \frac{1}{2} (x_i - \mu_c)^2 \right) $$ 

Now differentiate this double sum with respect to the mean of one of the components, say $\mu_2$, and set equal to zero:

$$ \sum_i \textrm{E}_{Z|X,\theta^t} \mathbb{1}(z_i = 2) (x_i - \mu_2) = 0 $$

$$ \sum_i w_i^2 (x_i - \mu_2) = 0 $$

$$ \hat{\mu}_2 = \frac{\sum_i w_i^2 x_i}{\sum_i w_i^2} $$

```{r}
n <- 4000
true.mus <- c(0, 5)
true.sigmas <- c(1, 4)
x <- c(rnorm(n/2, true.mus[1], sqrt(true.sigmas[1])),
       rnorm(n/2, true.mus[2], sqrt(true.sigmas[2])))
hist(x, breaks=50, col="grey")

alpha <- c(.5, .5)
mus <- c(1, 2)
sigmas <- c(1, 1)

library(rafalib)
niter <- 20

nullplot(true.mus[1]-5,true.mus[2]+5,0,niter)
abline(v=true.mus,lty=2)
points(true.mus, rep(0,2), pch=1:2, col="blue")
arrows(true.mus - sqrt(true.sigmas), rep(0,2),
       true.mus + sqrt(true.sigmas), rep(0,2),
       length=.1, code=3, col="blue")

points(mus, rep(1,2), pch=1:2)
arrows(mus - sqrt(sigmas), rep(1,2),
       mus + sqrt(sigmas), rep(1,2),
       length=.1, code=3)

for (i in 1:niter) {
  w <- cbind(alpha[1] * dnorm(x, mus[1], sqrt(sigmas[1])),
             alpha[2] * dnorm(x, mus[2], sqrt(sigmas[2])))
  w <- w / rowSums(w)
  N <- colSums(w)
  alpha <- N / n
  mus <- 1/N * c(sum(w[,1] * x), sum(w[,2] * x))
  sigmas <- 1/N * c(sum(w[,1] * (x - mus[1])^2),
                    sum(w[,2] * (x - mus[2])^2))
  points(mus, rep(i+1,2), pch=1:2)
  arrows(mus - sqrt(sigmas), rep(i+1,2),
         mus + sqrt(sigmas), rep(i+1,2),
         length=.1, code=3)
}

```

<https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1345710/>

```{r}
library(BSgenome.Hsapiens.UCSC.hg38)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
g <- genes(TxDb.Hsapiens.UCSC.hg38.knownGene)
promoters <- flank(g, width=1500, both=TRUE)
seq <- getSeq(Hsapiens, promoters)
gc <- as.vector( letterFrequency(seq, letters="GC") / 3000 )
cpg <- as.vector( vcountPDict(PDict("CG"), seq) / 3000 )
norm.cpg <- cpg / (gc/2)^2
hist(norm.cpg, breaks=50, col="grey")
```
